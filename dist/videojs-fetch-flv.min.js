/*! @name videojs-fetch-flv @version 1.0.11 @license MIT */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("global/document"),require("global/window"),require("video.js")):"function"==typeof define&&define.amd?define(["global/document","global/window","video.js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).videojsFetchFlv=e(t.document,t.window,t.videojs)}(this,(function(t,e,o){"use strict";function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var n=i(t),s=i(e),l=i(o);function r(t,e,o){return t(o={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&o.path)}},o.exports),o.exports}var a=r((function(t){function e(o,i){return t.exports=e=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},t.exports.default=t.exports,t.exports.__esModule=!0,e(o,i)}t.exports=e,t.exports.default=t.exports,t.exports.__esModule=!0})),h=r((function(t){t.exports=function(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,a(t,e)},t.exports.default=t.exports,t.exports.__esModule=!0})),c=l.default.getPlugin("plugin"),f={beforeElement:"fullscreenToggle",controlText:"Download",isLive:!0,position:"top-right",offsetH:0,offsetV:0,padding:10,opacity:.9},u=function(t){function e(e,o){var i;return(i=t.call(this,e,o)||this).addClass("vjs-fetch-flv-control"),i}return h(e,t),e.prototype.handleClick=function(){this.player().trigger("onFetchFlv")},e}(l.default.getComponent("Button")),d=function(t){function e(e,o){var i;return(i=t.call(this,e)||this).options=l.default.mergeOptions(f,o),i.div=null,i.fetching=!1,i.flash=!0,i.flashCount=0,i.data=[],i.type="video/x-flv",i.button=null,i.controller=null,i.filename=null,i.player.ready((function(){i.setup(),i.player.addClass("vjs-fetch-flv")})),i}h(e,t);var o=e.prototype;return o.createCtx=function(){var t=this.player.el(),e=n.default.createElement("div");e.classList.add("vjs-fetch-flv-ctx"),e.classList.add("vjs-fetch-flv-ctx-hide");var o=this.options,i=o.offsetH,s=o.offsetV;switch(this.options.position){case"top-left":e.style.top=s+"px",e.style.left=i+"px";break;case"top-right":e.style.top=s+"px",e.style.right=i+"px";break;case"bottom-left":e.style.bottom=s+"px",e.style.left=i+"px";break;case"bottom-right":e.style.bottom=s+"px",e.style.right=i+"px";break;default:e.style.top=s+"px",e.style.right=i+"px"}this.div=e,e.innerHTML='<span>REC</span> <span class="vjs-icon-placeholder vjs-fetch-flv-icon"></span>';var l=this.options.opacity;l&&(e.style.opacity=l),t.appendChild(e)},o.createButton=function(){var t=this,e=this.player,o=e.controlBar.addChild(new u(e,this.options),{});o.controlText(this.options.controlText),e.controlBar.el().insertBefore(o.el(),e.controlBar.getChild(this.options.beforeElement).el()),e.on("onFetchFlv",(function(){t.handleClick()})),this.button=o,e.on("timeupdate",(function(){t.fetching&&(t.flashCount++,t.flashCount%3==0&&(t.flash=!t.flash,t.div&&(t.flash?t.div.classList.remove("vjs-fetch-flv-ctx-hide"):t.div.classList.add("vjs-fetch-flv-ctx-hide"))))}))},o.setup=function(){null===this.div&&(this.createCtx(),this.createButton())},o.showFetch=function(){this.div&&this.div.classList.remove("vjs-fetch-flv-ctx-hide"),this.button&&this.button.addClass("vjs-fetch-flv-fetching")},o.hideFetch=function(){this.div&&this.div.classList.add("vjs-fetch-flv-ctx-hide"),this.button&&this.button.el_&&this.button.removeClass("vjs-fetch-flv-fetching")},o.show=function(){this.button&&this.button.show()},o.hide=function(){this.button&&this.button.hide()},o.start=function(){if(this.options.isLive)this.fetching||(this.fetching=!0,this.flash=!0,this.flashCount=0,this.showFetch(),this.fetchMedia(),this.player.trigger("fetchStart"));else{var t=this.player;s.default.open(t.currentSrc(),"Download")}},o.stop=function(t){if(this.fetching){if(this.hideFetch(),this.controller&&this.controller.abort(),this.fetching=!1,this.data.length>0&&t){var e=new s.default.Blob(this.data,{type:this.type});this.blob2File(e)}this.player.trigger("fetchStop")}},o.blob2File=function(t){if(null!==t){var e=s.default.URL.createObjectURL(t),o=n.default.createElement("a");o.style.display="none",o.href=e,o.download=this.filename,n.default.body.appendChild(o),o.click(),n.default.body.removeChild(o),s.default.URL.revokeObjectURL(e)}},o.url2Filename=function(t){return t?t.split("?")[0].split("\\").pop().split("/").pop():null},o.fetchMedia=function(){var t=this,e=this,o=this.player.currentSrc();this.filename=this.url2Filename(o),this.controller=new s.default.AbortController;var i=this.controller.signal;fetch(o,{signal:i}).then((function(t){var o=t.body.getReader();return e.type=t.headers.get("Content-Type"),e.data=[],new Promise((function(t){!function i(){o.read().then((function(o){var n=o.done,s=o.value;e.data.push(s),n?t(new Blob(e.data,{type:e.type})):i()})).catch((function(){}))}()}))})).then((function(e){t.fetching=!1,t.hideFetch(),t.blob2File(e)})).catch((function(){t.fetching=!1,t.hideFetch()}))},o.updateIsLive=function(t){this.options.isLive=t},o.handleClick=function(){this.options.isLive&&this.fetching?this.stop(!0):this.start()},e}(c);return d.defaultState={},d.VERSION="1.0.11",l.default.registerPlugin("fetchFlv",d),d}));
