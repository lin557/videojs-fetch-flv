/*! @name videojs-fetch-flv @version 1.0.4 @license MIT */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("global/document"),require("global/window"),require("video.js")):"function"==typeof define&&define.amd?define(["global/document","global/window","video.js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).videojsFetchFlv=e(t.document,t.window,t.videojs)}(this,(function(t,e,o){"use strict";function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=n(t),s=n(e),l=n(o);function r(t,e,o){return t(o={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&o.path)}},o.exports),o.exports}var a=r((function(t){function e(o,n){return t.exports=e=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},t.exports.default=t.exports,t.exports.__esModule=!0,e(o,n)}t.exports=e,t.exports.default=t.exports,t.exports.__esModule=!0})),c=r((function(t){t.exports=function(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,a(t,e)},t.exports.default=t.exports,t.exports.__esModule=!0})),f=l.default.getPlugin("plugin"),h={beforeElement:"fullscreenToggle",controlText:"Download",isLive:!0,position:"top-right",offsetH:0,offsetV:0,padding:10,opacity:.9},u=function(t){function e(e,o){var n;return n=t.call(this,e,o)||this,o.close?(n.addClass("vjs-fetch-flv-control"),n.el_.style="display: none"):n.addClass("vjs-fetch-flv-control"),n}return c(e,t),e.prototype.handleClick=function(){this.player().trigger("onFetchFlv")},e}(l.default.getComponent("Button")),p=function(t){function e(e,o){var n;return(n=t.call(this,e)||this).options=l.default.mergeOptions(h,o),n.div=null,n.fetching=!1,n.data=[],n.type="video/x-flv",n.button=null,n.controller=null,n.filename=null,n.player.ready((function(){n.setup(),n.player.addClass("vjs-fetch-flv")})),n}c(e,t);var o=e.prototype;return o.createCtx=function(){var t=this.player.el(),e=i.default.createElement("div");e.classList.add("vjs-fetch-flv-ctx"),e.classList.add("vjs-fetch-flv-ctx-hide"),e.style.padding=this.options.padding+"px";var o=this.options,n=o.offsetH,s=o.offsetV;switch(this.options.position){case"top-left":e.style.top=s+"px",e.style.left=n+"px";break;case"top-right":e.style.top=s+"px",e.style.right=n+"px";break;case"bottom-left":e.style.bottom=s+"px",e.style.left=n+"px";break;case"bottom-right":e.style.bottom=s+"px",e.style.right=n+"px";break;default:e.style.top=s+"px",e.style.right=n+"px"}this.div=e,e.innerHTML='<span>REC</span> <span class="vjs-icon-placeholder vjs-fetch-flv-icon"></span>';var l=this.options.opacity;l&&(e.style.opacity=l),t.appendChild(e)},o.createButton=function(){var t=this,e=this.player,o=e.controlBar.addChild(new u(e,this.options),{});o.controlText(this.options.controlText),e.controlBar.el().insertBefore(o.el(),e.controlBar.getChild(this.options.beforeElement).el()),e.on("onFetchFlv",(function(){t.handleClick()})),this.button=o},o.setup=function(){null===this.div&&(this.createCtx(),this.createButton())},o.show=function(){this.div&&this.div.classList.remove("vjs-fetch-flv-ctx-hide"),this.button&&this.button.addClass("vjs-fetch-flv-fetching")},o.hide=function(){this.div&&this.div.classList.add("vjs-fetch-flv-ctx-hide"),this.button&&this.button.removeClass("vjs-fetch-flv-fetching")},o.start=function(){if(this.options.isLive)this.fetching||(this.fetching=!0,this.show(),this.fetchMedia());else{var t=this.player;s.default.open(t.currentSrc(),"Download")}},o.stop=function(t){if(this.fetching&&(this.hide(),this.controller&&this.controller.abort(),this.fetching=!1,this.data.length>0&&t)){var e=new s.default.Blob(this.data,{type:this.type});this.blob2File(e)}},o.blob2File=function(t){if(null!==t){var e=s.default.URL.createObjectURL(t),o=i.default.createElement("a");o.style.display="none",o.href=e,o.download=this.filename,i.default.body.appendChild(o),o.click(),i.default.body.removeChild(o),s.default.URL.revokeObjectURL(e)}},o.url2Filename=function(t){return t?t.split("?")[0].split("\\").pop().split("/").pop():null},o.fetchMedia=function(){var t=this,e=this,o=this.player.currentSrc();this.filename=this.url2Filename(o),this.controller=new s.default.AbortController;var n=this.controller.signal;fetch(o,{signal:n}).then((function(t){var o=t.body.getReader();return e.type=t.headers.get("Content-Type"),e.data=[],new Promise((function(t){!function n(){o.read().then((function(o){var i=o.done,s=o.value;e.data.push(s),i?t(new Blob(e.data,{type:e.type})):n()})).catch((function(){}))}()}))})).then((function(e){t.fetching=!1,t.hide(),t.blob2File(e)})).catch((function(){t.fetching=!1,t.hide()}))},o.handleClick=function(){this.options.isLive&&this.fetching?this.stop(!0):this.start()},e}(f);return p.defaultState={},p.VERSION="1.0.4",l.default.registerPlugin("fetchFlv",p),p}));
