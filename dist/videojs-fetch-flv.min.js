/*! @name videojs-fetch-flv @version 1.0.0 @license MIT */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("video.js")):"function"==typeof define&&define.amd?define(["video.js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).videojsFetchFlv=e(t.videojs)}(this,(function(t){"use strict";function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var o=e(t);function n(t,e,o){return t(o={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&o.path)}},o.exports),o.exports}var i=n((function(t){function e(o,n){return t.exports=e=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},t.exports.default=t.exports,t.exports.__esModule=!0,e(o,n)}t.exports=e,t.exports.default=t.exports,t.exports.__esModule=!0})),s=n((function(t){t.exports=function(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,i(t,e)},t.exports.default=t.exports,t.exports.__esModule=!0})),l=o.default.getPlugin("plugin"),r={beforeElement:"fullscreenToggle",textControl:"Download",isLive:!0,position:"top-right",offsetH:0,offsetV:0,padding:10,opacity:.9},a=function(t){function e(e,o){var n;return(n=t.call(this,e,o)||this).addClass("vjs-fetch-flv-control"),n}return s(e,t),e.prototype.handleClick=function(){this.player().trigger("onFetchFlv")},e}(o.default.getComponent("Button")),c=function(t){function e(e,n){var i;return(i=t.call(this,e)||this).options=o.default.mergeOptions(r,n),i.div=null,i.fetching=!1,i.data=[],i.type="video/x-flv",i.button=null,i.controller=null,i.filename=null,i.player.ready((function(){i.setup(),i.player.addClass("vjs-fetch-flv")})),i}s(e,t);var n=e.prototype;return n.createCtx=function(){var t=this.player.el(),e=document.createElement("div");e.classList.add("vjs-fetch-flv-ctx"),e.classList.add("vjs-fetch-flv-ctx-hide"),e.style.padding=this.options.padding+"px";var o=this.options,n=o.offsetH,i=o.offsetV;switch(this.options.position){case"top-left":e.style.top=i+"px",e.style.left=n+"px";break;case"top-right":e.style.top=i+"px",e.style.right=n+"px";break;case"bottom-left":e.style.bottom=i+"px",e.style.left=n+"px";break;case"bottom-right":e.style.bottom=i+"px",e.style.right=n+"px";break;default:e.style.top=i+"px",e.style.right=n+"px"}this.div=e,e.innerHTML='<span>REC</span> <span class="vjs-icon-placeholder vjs-fetch-flv-icon"></span>';var s=this.options.opacity;s&&(e.style.opacity=s),t.appendChild(e)},n.createButton=function(){var t=this,e=this.player,o=e.controlBar.addChild(new a(e,this.options),{});o.controlText(this.options.textControl),e.controlBar.el().insertBefore(o.el(),e.controlBar.getChild(this.options.beforeElement).el()),e.on("onFetchFlv",(function(){t.handleClick()})),this.button=o},n.setup=function(){null==this.div&&(this.createCtx(),this.createButton())},n.show=function(){this.div&&this.div.classList.remove("vjs-fetch-flv-ctx-hide"),this.button&&this.button.addClass("vjs-fetch-flv-fetching")},n.hide=function(){this.div&&this.div.classList.add("vjs-fetch-flv-ctx-hide"),this.button&&this.button.removeClass("vjs-fetch-flv-fetching")},n.blob2File=function(t){if(null!=t){var e=window.URL.createObjectURL(t),o=document.createElement("a");o.style.display="none",o.href=e,o.download=this.filename,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(e)}},n.fetchMedia=function(){var t=this,e=this,o=this.player;this.fetching=!0;var n=o.currentSrc();this.filename=n.split("\\").pop().split("/").pop(),this.controller=new AbortController;var i=this.controller.signal;fetch(n,{signal:i}).then((function(t){var o=t.body.getReader();return e.type=t.headers.get("Content-Type"),e.data=[],new Promise((function(t){!function n(){o.read().then((function(o){var i=o.done,s=o.value;e.data.push(s),i?t(new Blob(e.data,{type:e.type})):n()}))}()}))})).then((function(e){t.fetching=!1,t.hide(),t.blob2File(e)})).catch((function(e){t.fetching=!1,t.hide(),console.log(e)}))},n.handleClick=function(){if(this.options.isLive){if(this.fetching){if(this.fetching=!1,this.data.length>0){var t=new Blob(this.data,{type:this.type});this.blob2File(t)}return this.hide(),void this.controller.abort()}this.show(),this.fetchMedia()}else{var e=this.player;window.open(e.currentSrc(),"Download")}},e}(l);return c.defaultState={},c.VERSION="1.0.0",o.default.registerPlugin("fetchFlv",c),c}));
